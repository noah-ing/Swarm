<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarm</title>
    <style>
        @font-face {
            font-family: 'Berkeley Mono';
            src: url('/fonts/BerkeleyMono-Regular.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Berkeley Mono';
            src: url('/fonts/BerkeleyMono-Bold.otf') format('opentype');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Berkeley Mono';
            src: url('/fonts/BerkeleyMono-Oblique.otf') format('opentype');
            font-weight: 400;
            font-style: italic;
        }
        @font-face {
            font-family: 'Berkeley Mono';
            src: url('/fonts/BerkeleyMono-Bold-Oblique.otf') format('opentype');
            font-weight: 700;
            font-style: italic;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #1a1a1a;
            --bg2: #222;
            --bg3: #2a2a2a;
            --border: #333;
            --text: #ccc;
            --dim: #666;
            --accent: #7a7;
            --red: #a66;
            --yellow: #aa7;
        }
        body {
            font-family: 'Berkeley Mono', 'Menlo', 'Monaco', monospace;
            font-size: 12px;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: var(--bg2);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border);
        }
        .header h1 {
            font-size: 14px;
            font-weight: normal;
            color: var(--accent);
        }
        .task-input {
            flex: 1;
            max-width: 500px;
            padding: 6px 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: inherit;
            font-size: 12px;
        }
        .task-input:focus { outline: none; border-color: var(--accent); }
        .run-btn {
            padding: 6px 16px;
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
        }
        .run-btn:hover { background: var(--border); }
        .run-btn:disabled { color: var(--dim); cursor: wait; }
        .status {
            margin-left: auto;
            color: var(--dim);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--red);
        }
        .status-dot.connected { background: var(--accent); }
        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 280px;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }
        .stats {
            grid-column: 1 / -1;
            display: flex;
            gap: 24px;
            padding: 12px 16px;
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
        }
        .stat { color: var(--dim); }
        .stat span { color: var(--text); margin-left: 6px; }
        .panels {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }
        .panel:last-child { border-bottom: none; }
        .panel-header {
            padding: 8px 12px;
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .panel-header h2 {
            font-size: 11px;
            font-weight: normal;
            text-transform: uppercase;
            color: var(--dim);
            letter-spacing: 1px;
        }
        .tabs { display: flex; gap: 4px; margin-left: auto; }
        .tab {
            padding: 2px 8px;
            background: none;
            border: 1px solid transparent;
            color: var(--dim);
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
        }
        .tab:hover { color: var(--text); }
        .tab.active { border-color: var(--border); color: var(--text); }
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .sidebar {
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* Events */
        .event {
            padding: 6px 8px;
            margin-bottom: 4px;
            border-left: 2px solid var(--border);
            background: var(--bg2);
        }
        .event.thought { border-left-color: #68a; }
        .event.message { border-left-color: #86a; }
        .event.task_start { border-left-color: var(--yellow); }
        .event.task_complete { border-left-color: var(--accent); }
        .event.task_error { border-left-color: var(--red); }
        .event.reflection { border-left-color: #a6a; }
        .event-header {
            display: flex;
            gap: 8px;
            margin-bottom: 2px;
            color: var(--dim);
            font-size: 10px;
        }
        .event-type { text-transform: uppercase; }
        .event-agent { color: var(--accent); }
        .event-time { margin-left: auto; }
        .event-content {
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
        }
        /* Agents */
        .agent {
            padding: 8px;
            margin-bottom: 4px;
            background: var(--bg2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .agent-icon {
            width: 24px;
            height: 24px;
            background: var(--bg3);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--dim);
        }
        .agent-name { flex: 1; }
        .agent-meta { color: var(--dim); font-size: 10px; }
        .agent-status {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--dim);
        }
        .agent-status.active { background: var(--accent); }
        .agent-status.testing { background: var(--yellow); }
        /* Thoughts */
        .thought-item {
            padding: 8px;
            margin-bottom: 4px;
            background: var(--bg2);
            border-left: 2px solid #68a;
        }
        .thought-agent {
            font-size: 10px;
            color: var(--dim);
            margin-bottom: 4px;
        }
        .thought-content {
            font-style: italic;
            color: var(--text);
            line-height: 1.4;
        }
        /* Messages */
        .msg {
            padding: 8px;
            margin-bottom: 4px;
            background: var(--bg2);
        }
        .msg-header {
            font-size: 10px;
            color: var(--dim);
            margin-bottom: 4px;
        }
        .msg-content { line-height: 1.4; }
        .empty {
            color: var(--dim);
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>swarm</h1>
        <input type="text" class="task-input" id="taskInput" placeholder="enter task..." onkeydown="if(event.key==='Enter')runTask()">
        <button class="run-btn" id="runBtn" onclick="runTask()">run</button>
        <div class="status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">connecting</span>
        </div>
    </header>
    <main class="main">
        <div class="stats">
            <div class="stat">agents<span id="sAgents">0</span></div>
            <div class="stat">tasks<span id="sTasks">0</span></div>
            <div class="stat">reflections<span id="sReflections">0</span></div>
            <div class="stat">success<span id="sSuccess">--%</span></div>
            <div class="stat">mutations<span id="sMutations">0</span></div>
            <div class="stat">gen<span id="sGen">0</span></div>
        </div>
        <div class="panels">
            <div class="panel" style="flex:2">
                <div class="panel-header">
                    <h2>activity</h2>
                    <div class="tabs">
                        <button class="tab active" data-view="all">all</button>
                        <button class="tab" data-view="thoughts">thoughts</button>
                        <button class="tab" data-view="messages">messages</button>
                        <button class="tab" data-view="tasks">tasks</button>
                    </div>
                </div>
                <div class="panel-content" id="eventStream"><div class="empty">waiting for events...</div></div>
            </div>
            <div class="panel">
                <div class="panel-header"><h2>dialogue</h2></div>
                <div class="panel-content" id="dialogue"><div class="empty">no dialogue</div></div>
            </div>
        </div>
        <div class="sidebar">
            <div class="panel">
                <div class="panel-header"><h2>agents</h2></div>
                <div class="panel-content" id="agents"><div class="empty">no agents</div></div>
            </div>
            <div class="panel">
                <div class="panel-header"><h2>thoughts</h2></div>
                <div class="panel-content" id="thoughts"><div class="empty">no thoughts</div></div>
            </div>
        </div>
    </main>
    <script>
        let ws, events = [], view = 'all';
        const roleAbbr = {executor:'EX',analyzer:'AN',validator:'VA',transformer:'TR',specialist:'SP'};

        function connect() {
            ws = new WebSocket(`${location.protocol==='https:'?'wss:':'ws:'}//${location.host}/ws`);
            ws.onopen = () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'connected';
            };
            ws.onclose = () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'disconnected';
                setTimeout(connect, 3000);
            };
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                if (d.type === 'initial_state') {
                    d.recent_events.forEach(ev => addEvent(ev, false));
                } else if (d.type !== 'pong') {
                    addEvent(d);
                }
            };
        }

        function addEvent(e, render = true) {
            events.unshift(e);
            if (events.length > 200) events.pop();
            if (render) renderEvents();
            if (['thought','reasoning'].includes(e.type)) addThought(e);
            if (['message','critique','proposal','consensus'].includes(e.type)) addDialogue(e);
        }

        function renderEvents() {
            const c = document.getElementById('eventStream');
            const f = events.filter(e => {
                if (view === 'all') return true;
                if (view === 'thoughts') return ['thought','reasoning','reflection'].includes(e.type);
                if (view === 'messages') return ['message','critique','proposal','consensus'].includes(e.type);
                if (view === 'tasks') return ['task_start','task_complete','task_error'].includes(e.type);
                return true;
            });
            if (!f.length) { c.innerHTML = '<div class="empty">no events</div>'; return; }
            c.innerHTML = f.slice(0,50).map(e => {
                const t = new Date(e.timestamp*1000).toLocaleTimeString();
                let content = (e.content||'').slice(0,300);
                if ((e.content||'').length > 300) content += '...';
                return `<div class="event ${e.type}">
                    <div class="event-header">
                        <span class="event-type">${e.type.replace('_',' ')}</span>
                        ${e.agent_name?`<span class="event-agent">${e.agent_name}</span>`:''}
                        ${e.target_agent_name?`<span>-></span><span class="event-agent">${e.target_agent_name}</span>`:''}
                        <span class="event-time">${t}</span>
                    </div>
                    <div class="event-content">${esc(content)}</div>
                </div>`;
            }).join('');
        }

        function addThought(e) {
            const c = document.getElementById('thoughts');
            if (c.querySelector('.empty')) c.innerHTML = '';
            const d = document.createElement('div');
            d.className = 'thought-item';
            d.innerHTML = `<div class="thought-agent">${e.agent_name||'agent'}</div><div class="thought-content">"${esc((e.content||'').slice(0,200))}"</div>`;
            c.insertBefore(d, c.firstChild);
            while (c.children.length > 10) c.removeChild(c.lastChild);
        }

        function addDialogue(e) {
            const c = document.getElementById('dialogue');
            if (c.querySelector('.empty')) c.innerHTML = '';
            const d = document.createElement('div');
            d.className = 'msg';
            d.innerHTML = `<div class="msg-header">${e.agent_name||''}${e.target_agent_name?' -> '+e.target_agent_name:''}</div><div class="msg-content">${esc((e.content||'').slice(0,200))}</div>`;
            c.insertBefore(d, c.firstChild);
            while (c.children.length > 20) c.removeChild(c.lastChild);
        }

        function loadAgents() {
            fetch('/api/agents').then(r=>r.json()).then(d => {
                const c = document.getElementById('agents');
                if (!d.agents||!d.agents.length) { c.innerHTML = '<div class="empty">no agents</div>'; return; }
                c.innerHTML = d.agents.map(a => {
                    const total = a.tasks_completed + a.tasks_failed;
                    const rate = total ? Math.round(a.tasks_completed/total*100) : 0;
                    return `<div class="agent">
                        <div class="agent-icon">${roleAbbr[a.role]||'AG'}</div>
                        <div class="agent-name">${a.name}</div>
                        <div class="agent-meta">g${a.generation} ${total}t ${rate}%</div>
                        <div class="agent-status ${a.status}"></div>
                    </div>`;
                }).join('');
            });
        }

        function loadStats() {
            fetch('/api/stats').then(r=>r.json()).then(d => {
                if (d.error) return;
                const af = d.agent_factory||{}, br = d.brain||{}, ev = d.evolution||{};
                document.getElementById('sAgents').textContent = af.active_agents||0;
                document.getElementById('sTasks').textContent = af.total_tasks||0;
                document.getElementById('sReflections').textContent = br.total_reflections||0;
                document.getElementById('sSuccess').textContent = (br.success_rate!==undefined?Math.round(br.success_rate*100):'--')+'%';
                document.getElementById('sMutations').textContent = ev.total_mutations||0;
                document.getElementById('sGen').textContent = af.max_generation||0;
            });
        }

        async function runTask() {
            const input = document.getElementById('taskInput');
            const btn = document.getElementById('runBtn');
            const task = input.value.trim();
            if (!task) return;
            btn.disabled = true; btn.textContent = 'running...';
            try {
                const r = await fetch('/api/run', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task})});
                const d = await r.json();
                if (d.error) alert(d.error);
                else { input.value = ''; loadStats(); loadAgents(); }
            } catch(e) { alert(e.message); }
            btn.disabled = false; btn.textContent = 'run';
        }

        document.querySelectorAll('.tab').forEach(t => {
            t.onclick = () => {
                document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                view = t.dataset.view;
                renderEvents();
            };
        });

        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        function pollHistory() {
            fetch('/api/history?limit=50').then(r=>r.json()).then(d => {
                if (d.events && d.events.length) {
                    const newEvents = d.events.filter(e => !events.find(x => x.timestamp === e.timestamp && x.type === e.type));
                    newEvents.reverse().forEach(e => addEvent(e));
                }
            }).catch(() => {});
        }

        connect();
        loadStats();
        loadAgents();
        pollHistory();
        setInterval(loadStats, 5000);
        setInterval(loadAgents, 10000);
        setInterval(pollHistory, 2000);
        setInterval(() => { if (ws?.readyState === 1) ws.send('ping'); }, 30000);
    </script>
</body>
</html>
